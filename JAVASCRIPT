import React, { useState, useEffect, useRef } from 'react';
import { Sparkles, Download, ArrowRight, Plane } from 'lucide-react';

// Initial Data
const INITIAL_PILOTS = [
  { id: 'P001', name: 'Arjun', location: 'Bangalore', status: 'Available', rate: 1500 },
  { id: 'P002', name: 'Neha', location: 'Mumbai', status: 'Assigned', rate: 3000 },
];

const INITIAL_DRONES = [
  { id: 'D001', model: 'DJI M300', location: 'Bangalore', status: 'Available' },
  { id: 'D003', model: 'DJI Mavic 3T', location: 'Mumbai', status: 'Available' },
];

export default function App() {
  const [pilots] = useState(INITIAL_PILOTS);
  const [drones] = useState(INITIAL_DRONES);
  const [missions, setMissions] = useState([]);
  const [isThinking, setIsThinking] = useState(false);
  const [chatInput, setChatInput] = useState('');
  const [chatHistory, setChatHistory] = useState([
    { role: 'agent', text: 'Hello! I am Skylark. I can help you book drone missions. What is your location and budget?' }
  ]);
  
  const chatEndRef = useRef(null);
  useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chatHistory]);

  const callGemini = async (userQuery) => {
    setIsThinking(true);
    // Your API Key is now here:
    const apiKey = "AIzaSyBLXfy381xOXoN9_ZvF3KDp9zb3vIsXDGk"; 

    const systemPrompt = `You are Skylark. Database: Pilots:${JSON.stringify(pilots)}, Drones:${JSON.stringify(drones)}. To book, end with ___BOOK_ACTION___ {"location":"...","assigned_pilot_id":"...","assigned_drone_id":"...","budget":1000}`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ role: 'user', parts: [{ text: userQuery }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] }
        })
      });

      const data = await response.json();
      const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response from AI.";
      
      if (aiText.includes('___BOOK_ACTION___')) {
        const [msg, json] = aiText.split('___BOOK_ACTION___');
        setChatHistory(prev => [...prev, { role: 'agent', text: msg.trim() }]);
        const booking = JSON.parse(json.trim());
        setMissions(prev => [...prev, { ...booking, id: Date.now() }]);
        setChatHistory(prev => [...prev, { role: 'agent', text: "âœ… Booking confirmed in system.", type: 'success' }]);
      } else {
        setChatHistory(prev => [...prev, { role: 'agent', text: aiText }]);
      }
    } catch (e) {
      setChatHistory(prev => [...prev, { role: 'agent', text: "Error: AI connection failed." }]);
    } finally {
      setIsThinking(false);
    }
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!chatInput.trim()) return;
    setChatHistory(prev => [...prev, { role: 'user', text: chatInput }]);
    callGemini(chatInput);
    setChatInput('');
  };

  return (
    <div className="flex flex-col h-screen bg-gray-50 text-slate-900">
      <header className="bg-slate-900 text-white p-4 flex justify-between items-center shadow-md">
        <h1 className="font-bold flex items-center gap-2 text-xl"><Plane className="text-blue-400" /> Skylark AI</h1>
        <div className="text-xs text-slate-400">Status: {missions.length} Missions Active</div>
      </header>

      <main className="flex-1 overflow-y-auto p-4 space-y-4">
        {chatHistory.map((msg, i) => (
          <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
            <div className={`max-w-[85%] p-4 rounded-2xl shadow-sm ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-800 rounded-tl-none'}`}>
              <p className="text-sm leading-relaxed">{msg.text}</p>
            </div>
          </div>
        ))}
        {isThinking && <div className="text-slate-400 text-xs animate-pulse flex items-center gap-2"><Sparkles size={14} className="animate-spin" /> Skylark is
